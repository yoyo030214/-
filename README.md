# Deepseek API 客户端工具

这是一套用于与Deepseek API交互的Python客户端工具，包括命令行工具和图形界面工具。

## 功能特点

- 单轮对话和多轮对话支持
- 会话管理（创建、获取历史、清除）
- 多种交互方式（命令行、交互式命令行、图形界面）
- 简单易用的API封装
- 高级功能：批量处理、保存会话历史、格式转换

## 依赖项

请确保已安装以下Python包：

```bash
pip install requests
```

如果要使用图形界面客户端，无需额外安装包，因为tkinter已包含在Python标准库中。

## 客户端库使用方法

### 1. Python API 客户端

`deepseek_client.py` 提供了一个简单的Python客户端库，可以在您的代码中导入使用：

```python
from deepseek_client import DeepseekClient

# 创建客户端实例
client = DeepseekClient(base_url="http://localhost:8080")

# 简单对话
response = client.chat_simple("你好，请介绍一下自己")
print(response)

# 创建会话
conversation_id = client.create_conversation()

# 在会话中发送消息
response = client.chat_with_conversation(conversation_id, "你好")
print(response)

# 获取会话历史
history = client.get_conversation_history(conversation_id)
for message in history:
    print(f"{message['role']}: {message['content']}")

# 清除会话
client.clear_conversation(conversation_id)
```

### 2. 命令行工具

`deepseek_cli.py` 提供了命令行界面，可以直接在终端中使用：

```bash
# 获取帮助
python deepseek_cli.py --help

# 发送单轮消息
python deepseek_cli.py chat "你好，请介绍一下自己"

# 创建新会话
python deepseek_cli.py create

# 在特定会话中发送消息
python deepseek_cli.py conv-chat 会话ID "你能帮我解决一个问题吗？"

# 查看会话历史
python deepseek_cli.py history 会话ID

# 清除会话历史
python deepseek_cli.py clear 会话ID

# 交互模式（推荐）
python deepseek_cli.py interactive
```

在交互模式中，可以使用以下特殊命令：
- `退出`: 结束会话并退出程序
- `清除`: 清除当前会话历史
- `历史`: 显示当前会话历史

### 3. 图形界面工具

`deepseek_gui.py` 提供了一个简单的图形界面客户端：

```bash
python deepseek_gui.py
```

图形界面功能：
- 设置服务器地址并连接
- 显示当前会话ID
- 清除会话历史
- 发送消息和查看回复
- 显示系统状态

### 4. 高级工具

`deepseek_utils.py` 提供了更高级的功能，适用于批量处理和数据分析：

```bash
# 获取帮助
python deepseek_utils.py --help

# 批量处理消息
python deepseek_utils.py batch 输入文件.txt 输出结果.json --workers 10

# 保存会话历史为不同格式
python deepseek_utils.py save 会话ID 会话记录.json
python deepseek_utils.py save 会话ID 会话记录.md --format markdown
python deepseek_utils.py save 会话ID 会话记录.txt --format text

# 批量生成内容
python deepseek_utils.py generate 提示列表.txt 输出目录 --format markdown

# 将文本文件转换为Markdown并应用AI分析
python deepseek_utils.py convert 原始文本.txt 格式化文档.md
```

批量处理功能详解：
- **batch**: 从文件中读取多条消息，并行处理后保存结果
- **save**: 将会话历史以JSON、Markdown或纯文本格式保存
- **generate**: 从文件读取多个提示，生成内容并保存到指定目录
- **convert**: 将普通文本文件转换为格式化的Markdown文档

## 服务器配置

默认情况下，客户端工具会连接到 `http://localhost:8080`。如果您的Deepseek API服务部署在其他地址，请使用相应参数进行设置：

- Python客户端：`client = DeepseekClient(base_url="http://your-server:port")`
- 命令行工具：`python deepseek_cli.py --host "http://your-server:port" command`
- 图形界面：在顶部输入框中设置服务器地址，然后点击"连接服务器"
- 高级工具：`python deepseek_utils.py --host "http://your-server:port" command`

## 开发说明

这些工具基于Java Spring Boot后端的Deepseek服务API。API支持以下端点：

- `/api/chat/simple`: 简单单轮对话
- `/api/chat/conversation`: 基于会话ID的多轮对话
- `/api/chat/messages`: 自定义消息列表对话
- `/api/conversation/create`: 创建新会话
- `/api/conversation/history`: 获取会话历史
- `/api/conversation/clear`: 清除会话历史

## 许可证

MIT 

# 语音功能模块开发进度

## 已完成功能

### 1. 语音API云函数
- [x] 创建云函数基础架构
- [x] 配置文件 (`config.js`)
- [x] 语音识别模块 (`recognition.js`) - 将语音转换为文本
- [x] 语音合成模块 (`synthesis.js`) - 将文本转换为语音
- [x] 云函数入口文件 (`index.js`) - 处理不同类型的请求

### 2. 客户服务页面集成
- [x] 录音功能 - 捕获用户语音输入
- [x] 语音识别 - 使用云函数将语音转为文本
- [x] 语音合成 - 使用云函数将AI回复转为语音
- [x] 语音播放 - 播放合成的语音回复
- [x] 语音对话连续模式 - 无需手动开始/停止录音
- [x] 语音识别实时反馈 - 提供录音时的波形动画和转写反馈
- [x] 语音播放进度显示 - 显示当前播放时间和总时长

### 3. 多语言支持
- [x] 多语言语音识别和合成 - 支持中文、英语、粤语、闽南语
- [x] 语言切换界面 - 用户可以快速切换不同语言
- [x] 语言设置持久化 - 记住用户的语言偏好

### 4. 离线语音功能
- [x] 基础离线语音指令识别 - 支持"帮助"、"清空"等基本指令
- [x] 缓存常用语音回复 - 减少网络请求，提高响应速度

### 5. 优化功能
- [x] 提高语音识别的响应速度 - 优化识别流程，支持多种识别模式
- [x] 优化语音质量 - 提供多种音质选项，支持语速和音调调节
- [x] 减小语音文件大小 - 智能压缩和文本优化技术

### 6. 高级语音功能
- [x] 语音情感分析 - 识别用户语音中的情感
- [ ] 降噪处理 - 提高嘈杂环境下的识别准确率

## 待开发功能

### 1. 高级语音功能
- [ ] 降噪处理 - 提高嘈杂环境下的识别准确率

## 使用说明

### 语音API云函数配置
确保在云函数的环境变量中设置以下配置：
```
AZURE_SPEECH_KEY=your_azure_speech_key
AZURE_SPEECH_REGION=eastasia
```

### 客户端调用示例
```javascript
// 语音识别示例
wx.cloud.callFunction({
  name: 'voiceAPI',
  data: {
    action: 'speechToText',
    params: {
      fileID: '云存储中的音频文件ID',
      language: 'zh-CN'
    }
  }
})

// 语音合成示例
wx.cloud.callFunction({
  name: 'voiceAPI',
  data: {
    action: 'textToSpeech',
    params: {
      text: '要转换为语音的文本',
      voice: 'zh-CN-XiaoxiaoNeural',
      language: 'zh-CN'
    }
  }
})

// 情感分析示例
wx.cloud.callFunction({
  name: 'voiceAPI',
  data: {
    action: 'analyzeEmotion',
    params: {
      fileID: '云存储中的音频文件ID',
      language: 'zh-CN'
    }
  }
})
```

### 连续对话模式说明
连续对话模式允许用户与AI进行自然的语音对话，无需手动开始/停止录音。使用方法：

1. 在楚农智能助手页面，开启"连续对话模式"
2. 点击麦克风按钮开始对话
3. 系统会自动检测语音输入、停顿，并将识别的文本发送给AI
4. AI回复可以自动语音播放（如果开启了"自动播放回复"）
5. 语音播放完毕后，系统会自动开始下一轮录音

该模式特别适合老年用户和需要免提交互的场景。

### 语音识别实时反馈
语音识别实时反馈功能为用户提供直观的录音状态和识别进度：

1. 语音波形动画 - 录音过程中显示动态波形，反映声音强度
2. 实时识别文本 - 显示当前已识别的文本内容，帮助用户确认录音效果
3. 状态提示 - 清晰显示"正在聆听"、"正在处理"等状态

这一功能提高了语音交互的用户体验，特别是对于初次使用语音功能的用户。

### 语音播放进度显示
语音播放进度显示功能让用户可以直观地了解语音播放的状态：

1. 进度条 - 显示当前播放进度的百分比
2. 时间指示 - 显示当前播放时间和总时长（如"0:15/1:30"）
3. 控制按钮 - 允许用户暂停/继续播放

这一功能对于长语音回复特别有用，让用户能够清楚知道还有多少内容需要收听。

### 多语言支持
多语言支持功能允许用户选择不同语言进行语音交互：

1. 语言选择器 - 提供简便的界面切换语言
2. 支持语言 - 目前支持普通话(zh-CN)、英语(en-US)、粤语(zh-HK)、闽南语(zh-TW)
3. 记忆功能 - 自动保存用户的语言偏好设置

切换语言后，语音识别和语音合成都会使用对应语言的模型，让不同语言或方言的用户都能获得良好的语音交互体验。

### 离线语音指令
离线语音指令功能允许用户通过语音快速执行常用操作，无需触摸屏幕：

1. 支持的指令：
   - "帮助" - 显示可用语音指令列表
   - "清空" - 清空当前对话记录
   - "回到首页" - 跳转到小程序首页
   - "设置" - 打开设置页面
   - "关闭" - 退出当前页面

2. 使用方法：
   - 在客户服务页面开启"语音指令"功能
   - 在录音过程中直接说出指令关键词
   - 系统会自动识别并执行相应操作

这一功能特别适合需要免手操作的场景，如驾驶、做饭或手部被占用的情况。

### 音频缓存
音频缓存功能可以存储已合成的语音回复，减少重复的网络请求：

1. 主要特点：
   - 自动缓存已合成的语音回复
   - 优先从缓存中读取，减少加载时间
   - 有容量限制，自动删除最旧的缓存

2. 使用方法：
   - 在客户服务页面开启"音频缓存"功能
   - 查看当前缓存数量和总容量
   - 自动管理缓存，无需额外操作

该功能适合网络条件不稳定或有流量限制的场景，提高了应用的响应速度和流畅度。

### 语音识别优化
语音识别优化功能通过多种技术手段提高识别速度和用户体验：

1. 主要特点：
   - 多模式支持：根据场景自动选择快速、标准或精确识别模式
   - 预识别技术：在用户说话过程中进行实时预识别
   - 智能缓冲：通过音频片段缓冲减少等待时间

2. 识别模式说明：
   - 快速模式：优先响应速度，适合简短指令和日常对话
   - 标准模式：平衡速度和准确性，适合一般场景
   - 精确模式：优先准确性，适合专业术语和复杂内容

3. 使用方法：
   - 在客户服务页面开启"语音识别优化"功能
   - 系统会自动根据对话内容选择合适的识别模式
   - 实时预识别结果会在录音过程中显示

该功能大幅提高了语音识别的响应速度，改善了用户在语音交互时的等待体验。

### 语音质量优化
语音质量优化功能让用户可以根据需求调整合成语音的质量参数：

1. 音质选择：
   - 高音质：更清晰自然的声音，适合需要高品质语音的场景
   - 标准音质：平衡音质和文件大小，适合一般场景
   - 低音质：减小音频文件大小，适合网络环境不佳的场景

2. 语音个性化：
   - 语速调节：提供从缓慢到快速的多级语速调整
   - 音调调节：支持调整语音的音调高低
   - 设置记忆：自动保存用户的偏好设置

3. 使用方法：
   - 在客户服务页面点击"语音质量设置"
   - 选择合适的音质级别
   - 根据个人喜好调整语速和音调
   - 设置会自动保存并应用到后续的所有语音合成中

该功能提高了语音合成的灵活性和用户体验，让用户可以根据自己的喜好和实际需求调整语音效果。

### 文件大小优化
文件大小优化功能通过多种技术手段减小语音文件的体积，节省流量和存储空间：

1. 技术手段：
   - 文本优化：自动清理文本中的冗余内容，如多余空格、重复标点等
   - 智能压缩：根据音频内容选择最合适的压缩参数
   - 自适应比特率：根据文本类型和内容复杂度动态调整音频比特率

2. 优化效果：
   - 可减小文件大小15%-40%，具体取决于内容
   - 保持良好的音质和清晰度
   - 显示优化前后的大小对比和减少百分比

3. 使用方法：
   - 在语音质量设置中开启"文件大小优化"开关
   - 系统会自动对新生成的语音文件进行优化
   - 优化完成后显示减少的文件大小百分比

该功能特别适合移动网络环境或流量敏感场景，在保持语音质量的同时显著减少数据传输量。

### 语音情感分析
语音情感分析功能可以识别用户语音中的情感，提供更加个性化的交互体验：

1. 可识别的情感：
   - 开心：用户表达愉悦、满意或兴奋的情绪
   - 伤心：用户表达难过、失望或悲伤的情绪
   - 生气：用户表达愤怒、不满或烦躁的情绪
   - 害怕：用户表达恐惧、担忧或紧张的情绪
   - 惊讶：用户表达惊讶、震惊或意外的情绪
   - 平静：用户没有明显情绪变化

2. 主要功能：
   - 实时情感识别：分析用户语音中的情感变化
   - 情感可视化：直观显示各种情感的占比
   - 情感响应：根据用户情感调整交互方式

3. 使用方法：
   - 在客户服务页面开启"情感分析"功能
   - 系统会自动分析每次语音输入中的情感
   - 在界面上显示情感分析结果
   - 查看各种情感的详细占比

该功能让AI助手更加了解用户的情感状态，能够提供更加个性化、人性化的服务，特别适合需要情感关怀的场景，如心理疏导、情感陪伴等。 