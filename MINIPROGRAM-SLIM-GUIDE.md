# 楚农电商小程序瘦身指南

本文档提供了一系列方法来减少小程序的体积，解决小程序无法正常上传的问题。

## 当前问题

微信小程序有严格的体积限制：
- 主包最大不超过 2MB
- 分包总计最大不超过 12MB

经过分析，当前小程序体积过大的主要原因是：
- images 目录有 60 个文件，总大小约为 33MB
- 未使用分包加载策略
- 可能包含未使用的资源文件
- 代码可能未经过优化

## 解决方案

### 1. 图片压缩（当务之急）

**基本方法**：
```bash
# 安装依赖
npm install sharp --save-dev

# 运行图片压缩脚本
npm run compress-images
```

这将大幅减少图片体积，通常可以减少30-70%的空间。

**深度优化**：
1. 将大于 100KB 的图片上传到云存储或 CDN，通过网络加载
2. 将小图标换成字体图标
3. 使用 base64 编码内联小图片（小于 10KB）
4. 使用 WebP 格式替代 JPG 和 PNG

### 2. 分包加载

分包是减小主包体积的最佳方法，可以按照功能将小程序拆分为多个包：

**查看分包建议**：
```bash
node subpackage-config.js
```

**手动实施分包**：
1. 保留 tabBar 页面在主包中
2. 创建分包目录结构
3. 将非主包页面迁移到分包中
4. 更新 app.json 配置

### 3. 清理未使用的资源

**运行清理脚本**：
```bash
npm run clean-unused
```

这将扫描项目中未被引用的图片和其他资源文件，并将它们移动到备份目录。

### 4. 代码优化

1. **移除调试代码**：
   - 删除所有的 console.log 语句
   - 删除注释掉的代码块

2. **压缩和混淆**：
   ```bash
   npm run build:prod
   ```

3. **按需引入第三方库**：
   - 检查 package.json 中的依赖
   - 只引入需要的功能，不要整包引入

### 5. 配置优化

1. **启用代码压缩**：
   - 确保 project.config.json 中设置了 `"minified": true`
   - 启用 WXML 和 WXSS 压缩

2. **忽略开发文件**：
   - 设置 `"ignoreDevUnusedFiles": true`
   - 设置 `"ignoreUploadUnusedFiles": true`

## 建议的优化顺序

1. 首先，压缩图片资源
2. 其次，清理未使用的资源
3. 然后，进行代码优化
4. 最后，实施分包策略

按照上述步骤操作后，小程序的体积应该能够显著减小，满足微信对小程序大小的限制。

## 进阶优化建议

### 使用云开发

考虑将部分功能迁移到云函数中，减少客户端代码体积。

### 延迟加载

对于非关键资源，使用按需加载的策略，减少初始加载时间。

### 使用插件

某些通用功能可以使用微信官方或第三方插件，而不是自己实现。

---

如有任何问题，请联系开发团队。 